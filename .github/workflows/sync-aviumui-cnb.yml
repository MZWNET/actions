name: Sync AviumUI org repos to CNB
on:
  # schedule:
  #   - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - ".github/workflows/sync-aviumui-cnb.yml"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync all AviumUI repos to CNB
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CNB_PASSWORD: ${{ secrets.CNB_GIT_PASSWORD }}
        run: |
          git lfs install
          git config --global lfs.locksverify true

          sync_repo() {
            set -e
            local repo_json="$1"
            local repo desc payload response http_code body
            repo=$(echo "$repo_json" | jq -r '.name')
            if [ "$repo" = ".github" ]; then
              echo "Skipping .github repo"
              return 0
            fi
            desc=$(echo "$repo_json" | jq -r '.description // empty')
            echo "::group::Syncing $repo"

            # Build JSON payload with jq to handle special characters
            if [ -z "$desc" ]; then
              desc="Mirror of https://github.com/AviumUI/${repo}"
            fi
            payload=$(jq -n \
              --arg name "$repo" \
              --arg desc "$desc" \
              '{name: $name, description: $desc, visibility: "public"}')

            # Create repo on CNB if not exists
            response=$(curl --silent --write-out "\n%{http_code}" \
              --request POST \
              --url "https://api.cnb.cool/MZWNET/AviumUI/-/repos" \
              --header "Authorization: Bearer ${CNB_PASSWORD}" \
              --header "Content-Type: application/json" \
              --data "$payload")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "Repo ${repo} created successfully"
            elif [ "$http_code" -eq 409 ]; then
              echo "Repo ${repo} already exists, skipping creation"
            else
              echo "::error::Failed to create repo ${repo}, HTTP ${http_code}: ${body}"
              return 1
            fi

            local workdir="sync_${repo}"
            git clone --mirror "https://github.com/AviumUI/${repo}.git" "${workdir}"
            cd "${workdir}"
            git lfs fetch --all "https://github.com/AviumUI/${repo}.git"
            git remote add cnb "https://cnb:${CNB_PASSWORD}@cnb.cool/MZWNET/AviumUI/${repo}.git"
            git push cnb --force 'refs/heads/*:refs/heads/*' 'refs/tags/*:refs/tags/*'
            git lfs push --all cnb
            cd ..
            rm -rf "${workdir}"
            echo "::endgroup::"
          }
          export -f sync_repo
          export CNB_PASSWORD

          MAX_PARALLEL=5
          gh api --paginate "/orgs/AviumUI/repos" --jq '.[] | @json' | \
            tr '\n' '\0' | xargs -0 -n 1 -P "$MAX_PARALLEL" bash -c 'sync_repo "$1"' _

          echo "All repos synced"

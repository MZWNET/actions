name: Sync AviumUI org repos to CNB
on:
  # schedule:
  #   - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - ".github/workflows/sync-aviumui-cnb.yml"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync all AviumUI repos to CNB
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CNB_PASSWORD: ${{ secrets.CNB_GIT_PASSWORD }}
        run: |
          git lfs install
          repos=$(gh api --paginate "/orgs/AviumUI/repos" --jq '.[] | "\(.name)\t\(.description // "")"')
          while IFS=$'\t' read -r repo desc; do
            echo "::group::Syncing $repo"

            # Create repo on CNB if not exists
            trimmed_desc=$(echo "$desc" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            response=$(curl --silent --write-out "\n%{http_code}" \
              --request POST \
              --url "https://api.cnb.cool/MZWNET/AviumUI/-/repos" \
              --header "Authorization: Bearer ${CNB_PASSWORD}" \
              --header "Content-Type: application/json" \
              --data "{
                \"name\": \"${repo}\",
                \"description\": $(echo "$trimmed_desc" | jq -Rs .),
                \"visibility\": \"public\"
              }")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "Repo ${repo} created successfully"
            elif [ "$http_code" -eq 409 ]; then
              echo "Repo ${repo} already exists, skipping creation"
            else
              echo "::error::Failed to create repo ${repo}, HTTP ${http_code}: ${body}"
              exit 1
            fi

            git clone --mirror "https://github.com/AviumUI/${repo}.git" "${repo}"
            cd "${repo}"
            git lfs fetch --all "https://github.com/AviumUI/${repo}.git"
            git remote add cnb "https://cnb:${CNB_PASSWORD}@cnb.cool/MZWNET/AviumUI/${repo}.git"
            git push cnb --mirror --force
            git lfs push --all cnb
            cd ..
            rm -rf "${repo}"
            echo "::endgroup::"
          done <<< "$repos"
